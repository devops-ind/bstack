/**
 * Seed Job Jenkinsfile
 *
 * This Jenkinsfile runs the JobDSL script to create/update Jenkins jobs.
 * Use this as an alternative to creating a freestyle seed job.
 *
 * Setup:
 * 1. Create a Pipeline job in Jenkins named "seed-browserstack-uploader"
 * 2. Configure it to use this Jenkinsfile from SCM
 * 3. Run the job to create/update the multi-branch pipeline
 *
 * The seed job will:
 * - Clone this repository
 * - Execute the JobDSL script
 * - Create/update the BrowserStack uploader multi-branch pipeline
 */

pipeline {
    agent any

    options {
        timestamps()
        timeout(time: 10, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        ansiColor('xterm')
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘        Seed Job - BrowserStack Uploader JobDSL        â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                    echo "ğŸ“¦ Checking out repository..."
                }

                // Checkout the repository containing DSL scripts
                checkout scm
            }
        }

        stage('Validate DSL Scripts') {
            steps {
                script {
                    echo ""
                    echo "âœ“ STAGE: Validate JobDSL Scripts"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

                    // Check if DSL script exists
                    def dslScript = 'jenkins/jobdsl/browserstack-uploader-multibranch.groovy'
                    if (!fileExists(dslScript)) {
                        error("âŒ DSL script not found: ${dslScript}")
                    }

                    echo "âœ… DSL script found: ${dslScript}"

                    // Display script info
                    def scriptSize = sh(
                        script: "wc -l < ${dslScript}",
                        returnStdout: true
                    ).trim()

                    echo "   Lines: ${scriptSize}"
                    echo "   Path:  ${pwd()}/${dslScript}"
                }
            }
        }

        stage('Process JobDSL') {
            steps {
                script {
                    echo ""
                    echo "ğŸš€ STAGE: Process JobDSL Script"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }

                // Process the JobDSL script
                jobDsl(
                    targets: 'jenkins/jobdsl/browserstack-uploader-multibranch.groovy',
                    removedJobAction: 'DELETE',
                    removedViewAction: 'DELETE',
                    removedConfigFilesAction: 'DELETE',
                    lookupStrategy: 'SEED_JOB',
                    additionalClasspath: '',
                    failOnMissingPlugin: true,
                    failOnSeedCollision: false,
                    unstableOnDeprecation: false,
                    sandbox: false  // Set to true if you want sandboxed execution
                )

                script {
                    echo ""
                    echo "âœ… JobDSL processing completed"
                }
            }
        }

        stage('Verify Jobs Created') {
            steps {
                script {
                    echo ""
                    echo "ğŸ” STAGE: Verify Job Creation"
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

                    // List of expected jobs
                    def expectedJobs = [
                        'Mobile-DevOps/browserstack-uploader',
                        'Mobile-DevOps/browserstack-manual-upload'
                    ]

                    echo "Expected jobs to be created:"
                    expectedJobs.each { job ->
                        echo "  â€¢ ${job}"
                    }

                    echo ""
                    echo "âœ… Job creation verification complete"
                    echo "   Check Jenkins UI to confirm jobs were created"
                }
            }
        }

        stage('Display Next Steps') {
            steps {
                script {
                    echo ""
                    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                    echo "â•‘                        Seed Job Completed Successfully                     â•‘"
                    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                    echo ""
                    echo "ğŸ“‹ NEXT STEPS:"
                    echo ""
                    echo "1ï¸âƒ£  Verify Jobs Created:"
                    echo "   â€¢ Go to Jenkins Dashboard"
                    echo "   â€¢ Navigate to: Mobile-DevOps folder"
                    echo "   â€¢ Confirm these jobs exist:"
                    echo "     - browserstack-uploader (multi-branch pipeline)"
                    echo "     - browserstack-manual-upload (freestyle job)"
                    echo ""
                    echo "2ï¸âƒ£  Configure Credentials (if not already done):"
                    echo "   â€¢ Manage Jenkins â†’ Manage Credentials â†’ System â†’ Global"
                    echo "   â€¢ Add these credentials:"
                    echo "     - browserstack-user (Secret text)"
                    echo "     - browserstack-access-key (Secret text)"
                    echo "     - github-token (Secret text)"
                    echo "     - github-credentials (Username/Password or SSH)"
                    echo "     - teams-webhook-url (Secret text, optional)"
                    echo ""
                    echo "3ï¸âƒ£  Configure GitHub Webhook (optional but recommended):"
                    echo "   â€¢ GitHub Repository â†’ Settings â†’ Webhooks â†’ Add webhook"
                    echo "   â€¢ Payload URL: ${env.JENKINS_URL}github-webhook/"
                    echo "   â€¢ Content type: application/json"
                    echo "   â€¢ Events: Just the push event"
                    echo ""
                    echo "4ï¸âƒ£  Initial Branch Scan:"
                    echo "   â€¢ Go to: Mobile-DevOps/browserstack-uploader"
                    echo "   â€¢ Click: 'Scan Repository Now'"
                    echo "   â€¢ Wait for branch discovery to complete"
                    echo ""
                    echo "5ï¸âƒ£  Test the Pipeline:"
                    echo "   â€¢ Select a branch (e.g., main)"
                    echo "   â€¢ Click: 'Build with Parameters'"
                    echo "   â€¢ Fill in parameters and click 'Build'"
                    echo ""
                    echo "ğŸ“š Documentation:"
                    echo "   â€¢ JobDSL Guide:    jenkins/jobdsl/README.md"
                    echo "   â€¢ Jenkins Guide:   jenkins/README.md"
                    echo "   â€¢ Jenkinsfile:     jenkins/Jenkinsfile-DevOps-TriggerReady"
                    echo ""
                    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                }
            }
        }
    }

    post {
        success {
            script {
                echo ""
                echo "âœ… Seed job completed successfully!"
                echo ""

                // Optional: Send notification
                // Can integrate with Teams, Slack, email, etc.
            }
        }

        failure {
            script {
                echo ""
                echo "âŒ Seed job failed!"
                echo ""
                echo "Common issues:"
                echo "  â€¢ Job DSL plugin not installed"
                echo "  â€¢ Script security approval needed"
                echo "  â€¢ Invalid DSL syntax"
                echo ""
                echo "Check console output above for specific error details."
            }
        }

        always {
            script {
                echo ""
                echo "Seed job execution completed at: ${new Date()}"
            }
        }
    }
}
